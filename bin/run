#!/bin/sh
set -e

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° VPN ÑÐµÑ€Ð²ÐµÑ€Ð°..."

# Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
[ -d /dev/net ] || mkdir -p /dev/net
[ -c /dev/net/tun ] || mknod /dev/net/tun c 10 200

cd /etc/openvpn

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ„Ð°Ð¹Ð»Ñ‹, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
touch placeholder

[ -f dh.pem ] || openssl dhparam -out dh.pem 2048
[ -f key.pem ] || openssl genrsa -out key.pem 2048
chmod 600 key.pem
[ -f csr.pem ] || openssl req -new -key key.pem -out csr.pem -subj /CN=OpenVPN/
[ -f cert.pem ] || openssl x509 -req -in csr.pem -out cert.pem -signkey key.pem -days 24855

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ OpenVPN (TCP 443)
[ -f tcp443.conf ] || cat >tcp443.conf <<EOF
server 192.168.255.0 255.255.255.128
verb 3
duplicate-cn
key key.pem
ca cert.pem
cert cert.pem
dh dh.pem
keepalive 10 60
persist-key
persist-tun
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 1.1.1.1"
cipher AES-256-CBC
auth SHA512
tls-version-min 1.2
proto tcp-server
port 443
dev tun443
status openvpn-status-443.log
EOF

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ OpenVPN (UDP 1194)
[ -f udp1194.conf ] || cat >udp1194.conf <<EOF
server 192.168.255.128 255.255.255.128
verb 3
duplicate-cn
key key.pem
ca cert.pem
cert cert.pem
dh dh.pem
keepalive 10 60
persist-key
persist-tun
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 1.1.1.1"
cipher AES-256-CBC
auth SHA512
tls-version-min 1.2
proto udp
port 1194
dev tun1194
status openvpn-status-1194.log
EOF

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP ÑÐµÑ€Ð²ÐµÑ€Ð°
MY_IP_ADDR=$(curl -s http://ifconfig.me)
[ "$MY_IP_ADDR" ] || {
    echo "ÐžÑˆÐ¸Ð±ÐºÐ°: Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP."
    exit 1
}

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° OpenVPN
[ -f client.ovpn ] || cat >client.ovpn <<EOF
client
nobind
dev tun
redirect-gateway def1

<key>
`cat key.pem`
</key>
<cert>
`cat cert.pem`
</cert>
<ca>
`cat cert.pem`
</ca>
<dh>
`cat dh.pem`
</dh>

<connection>
remote $MY_IP_ADDR 1194 udp
</connection>

<connection>
remote $MY_IP_ADDR 443 tcp-client
</connection>
EOF

# Ð’Ñ‹Ð´Ð°Ñ‡Ð° `.ovpn` Ñ‡ÐµÑ€ÐµÐ· HTTP
[ -f client.http ] || cat >client.http <<EOF
HTTP/1.0 200 OK
Content-Type: application/x-openvpn-profile
Content-Length: `wc -c client.ovpn`

`cat client.ovpn`
EOF

# ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ, Ð¿Ð¾ÐºÐ° Ð’Ð¡Ð• Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ OpenVPN
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð²ÑÐµÑ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
while [ ! -f dh.pem ] || [ ! -f tcp443.conf ] || [ ! -f udp1194.conf ] || [ ! -f client.ovpn ]; do
    sleep 2
    echo "ðŸ”„ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² ÐµÑ‰Ñ‘ Ð½Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°..."
done
echo "âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ VPN!"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¼Ð°ÑÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸ VPN Ñ‡ÐµÑ€ÐµÐ· STUNNEL (HTTPS)
cat > /etc/stunnel/stunnel.conf <<EOF
[openvpn]
accept = 443
connect = 127.0.0.1:1194
cert = /etc/openvpn/cert.pem
key = /etc/openvpn/key.pem
EOF

stunnel /etc/stunnel/stunnel.conf &

# ÐŸÑ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ‚Ñ€Ð°Ñ„Ð¸Ðº Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² VPN
iptables -t nat -A POSTROUTING -s 192.168.255.0/24 -o eth0 -j MASQUERADE

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ OpenVPN (TCP + UDP)
touch tcp443.log udp1194.log http8080.log
while true ; do openvpn --config tcp443.conf ; done >> tcp443.log &
while true ; do openvpn --config udp1194.conf ; done >> udp1194.log &
tail -F *.log