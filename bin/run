#!/bin/sh
set -e

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPN —Å–µ—Ä–≤–µ—Ä–∞..."

# –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
[ -d /dev/net ] || mkdir -p /dev/net
[ -c /dev/net/tun ] || mknod /dev/net/tun c 10 200

# –ü–∞–ø–∫–∞ –¥–ª—è OpenVPN
cd /etc/openvpn

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º/–ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∫–ª—é—á–∏ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
[ -f dh.pem ] || openssl dhparam -out dh.pem 2048

# –°–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–ª—é—á/—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ "CA")
if [ ! -f key.pem ]; then
    openssl genrsa -out key.pem 2048
    chmod 600 key.pem
fi

[ -f csr.pem ] || openssl req -new -key key.pem -out csr.pem -subj /CN=OpenVPN/
[ -f cert.pem ] || openssl x509 -req -in csr.pem -out cert.pem -signkey key.pem -days 24855

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª—é—á/—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–º (—Ñ–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî ¬´CA¬ª)
if [ ! -f client-key.pem ]; then
    openssl genrsa -out client-key.pem 2048
    chmod 600 client-key.pem
fi

if [ ! -f client-csr.pem ]; then
    openssl req -new -key client-key.pem -out client-csr.pem -subj /CN=OpenVPN-Client/
fi

if [ ! -f client-cert.pem ]; then
    # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π CSR ¬´—Å–µ—Ä–≤–µ—Ä–Ω—ã–º¬ª –∫–ª—é—á–æ–º –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º (–∫–∞–∫ CA)
    # -CAcreateserial —Å–æ–∑–¥–∞—Å—Ç/–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–π–ª cert.srl
    openssl x509 -req -in client-csr.pem -out client-cert.pem \
        -CA cert.pem -CAkey key.pem -CAcreateserial -days 24855
fi

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OpenVPN (TCP 443 —á–µ—Ä–µ–∑ stunnel -> 1443)
if [ ! -f tcp443.conf ]; then
    cat >tcp443.conf <<EOF
server 192.168.255.0 255.255.255.128
topology subnet
verb 3
duplicate-cn
key key.pem
ca cert.pem
cert cert.pem
dh dh.pem
keepalive 10 60
persist-key
persist-tun
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 1.1.1.1"
data-ciphers AES-256-GCM:AES-128-GCM:CHACHA20-POLY1305
data-ciphers-fallback AES-256-CBC
auth SHA512
tls-version-min 1.2
proto tcp-server
port 1443
dev tun443
status openvpn-status-443.log
EOF
fi

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OpenVPN (UDP 1194)
if [ ! -f udp1194.conf ]; then
    cat >udp1194.conf <<EOF
server 192.168.255.128 255.255.255.128
topology subnet
verb 3
duplicate-cn
key key.pem
ca cert.pem
cert cert.pem
dh dh.pem
keepalive 10 60
persist-key
persist-tun
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 1.1.1.1"
data-ciphers AES-256-GCM:AES-128-GCM:CHACHA20-POLY1305
data-ciphers-fallback AES-256-CBC
auth SHA512
tls-version-min 1.2
proto udp
port 1194
dev tun1194
status openvpn-status-1194.log
EOF
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π IP —Å–µ—Ä–≤–µ—Ä–∞
MY_IP_ADDR=$(curl -s http://ifconfig.me)
if [ -z "$MY_IP_ADDR" ]; then
    echo "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π IP."
    exit 1
fi

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenVPN
if [ ! -f client.ovpn ]; then
    cat >client.ovpn <<EOF
client
nobind
dev tun
topology subnet
redirect-gateway def1 bypass-dhcp
remote-cert-tls server
resolv-retry infinite
persist-key
persist-tun

# –ü–æ–ø—ã—Ç–∫–∞ —Å–Ω–∞—á–∞–ª–∞ –ø–æ UDP, –ø–æ—Ç–æ–º –ø–æ TCP
<connection>
remote $MY_IP_ADDR 1194
proto udp
</connection>

<connection>
remote $MY_IP_ADDR 443
proto tcp-client
</connection>

# –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
data-ciphers AES-256-GCM:AES-128-GCM:CHACHA20-POLY1305
data-ciphers-fallback AES-256-CBC
auth SHA512
tls-version-min 1.2

# –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–∞—Ä–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞)
<key>
$(cat client-key.pem)
</key>

<cert>
$(cat client-cert.pem)
</cert>

# –í –∫–∞—á–µ—Å—Ç–≤–µ CA –∑–¥–µ—Å—å –ø–æ–¥—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ—Ç –∂–µ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π cert.pem,
# –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –≤—ã—Å—Ç—É–ø–∞–µ—Ç "CA" (–Ω–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ –ª—É—á—à–µ, —á–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–∏–∫ —Å–µ—Ä–≤–µ—Ä–∞)
<ca>
$(cat cert.pem)
</ca>
EOF
fi

# –í—ã–¥–∞—á–∞ `.ovpn` —á–µ—Ä–µ–∑ HTTP
if [ ! -f client.http ]; then
    CONTENT_LENGTH=$(wc -c < client.ovpn)
    cat >client.http <<EOF
HTTP/1.0 200 OK
Content-Type: application/x-openvpn-profile
Content-Length: $CONTENT_LENGTH

$(cat client.ovpn)
EOF
fi

# –û–∂–∏–¥–∞–Ω–∏–µ, –ø–æ–∫–∞ –í–°–ï —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º OpenVPN
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤..."
while [ ! -f dh.pem ] || \
      [ ! -f tcp443.conf ] || \
      [ ! -f udp1194.conf ] || \
      [ ! -f client.ovpn ]; do
    sleep 2
    echo "üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞..."
done
echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã, –∑–∞–ø—É—Å–∫–∞–µ–º VPN!"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ VPN —á–µ—Ä–µ–∑ STUNNEL (HTTPS)
cat > /etc/stunnel/stunnel.conf <<EOF
[openvpn]
accept = 443
connect = 127.0.0.1:1443
cert = /etc/openvpn/cert.pem
key = /etc/openvpn/key.pem

; –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∂–µ—Å—Ç–æ—á–∏—Ç—å –≤–µ—Ä—Å–∏–∏ TLS:
sslVersion = TLSv1.2
options = NO_SSLv2
options = NO_SSLv3
options = NO_TLSv1
options = NO_TLSv1.1
EOF

stunnel /etc/stunnel/stunnel.conf &

# –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ VPN
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å 'eth0' –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ò–Ω–∞—á–µ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—ã–π.
iptables -t nat -A POSTROUTING -s 192.168.255.0/24 -o eth0 -j MASQUERADE

# –ó–∞–ø—É—Å–∫–∞–µ–º OpenVPN (TCP + UDP)
touch tcp443.log udp1194.log
while true; do
    openvpn --config tcp443.conf
done >> tcp443.log 2>&1 &

while true; do
    openvpn --config udp1194.conf
done >> udp1194.log 2>&1 &

# –í—ã–≤–æ–¥–∏–º –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (–∫–æ–ΩTAINER-friendly)
tail -F *.log