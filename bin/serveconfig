#!/bin/sh
cd /etc/openvpn

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
sleep 1

[ -f placeholder ] || {
    echo "‚ùå –û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OpenVPN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ñ–∞–π–ª."
    exit 1
}

while ! [ -f client.http ]; do
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ client.http..."
    sleep 3
done

echo "‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω! –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:"
echo "https://$(curl -s https://ifconfig.me):8080/"

# –ó–∞–ø—É—Å–∫–∞–µ–º `socat` –≤ —Ñ–æ–Ω–µ
while [ -f client.http ]; do
    echo "üåç –ó–∞–ø—É—Å–∫–∞–µ–º HTTP-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ client.ovpn..."
    socat -d -d \
        OPENSSL-LISTEN:8080,fork,reuseaddr,key=key.pem,certificate=cert.pem,verify=0 \
        EXEC:'cat client.http' \
        2>> http8080.log &
    
    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–ª–∞–≥, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    rm -f /tmp/client_downloaded.marker

    echo "üåç –ó–∞–ø—É—Å–∫–∞–µ–º HTTP-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ client.ovpn..."
    socat -d -d \
        OPENSSL-LISTEN:8080,fork,reuseaddr,key=key.pem,certificate=cert.pem,verify=0 \
        EXEC:'/usr/local/sbin/serve_client.sh' \
        2>> http8080.log &
        
    SOCAT_PID=$!

    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è client.http..."

    # –û–∂–∏–¥–∞–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞-—Ñ–ª–∞–≥–∞
    while [ ! -f /tmp/client_downloaded.marker ]; do
        sleep 1
    done

    echo "‚úÖ –§–∞–π–ª client.http –±—ã–ª —Å–∫–∞—á–∞–Ω. –£–¥–∞–ª—è–µ–º..."
    sleep 2
    rm -f client.http
    echo "üö™ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTTP-—Å–µ—Ä–≤–µ—Ä."
    kill $SOCAT_PID  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `socat`
    
    echo "üîÑ –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ client.http..."
    while ! [ -f client.http ]; do
        sleep 3
    done
done